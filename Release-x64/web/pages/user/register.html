<!DOCTYPE html>
<html lang="zh-cn">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>用户注册</title>
    <script src="/res/js/tailwind.js"></script>
    <script src="/res/js/jquery-3.7.1.min.js"></script>
    <script src="/res/js/vue.global.js"></script>
    <script src="/res/js/axios.min.js"></script>
    <script src="/res/js/echarts.min.js"></script>
    <script src="/res/js/element-plus.js"></script>
    <link rel="stylesheet" href="/res/css/element-plus.css">
    <script src="/res/js/all.js"></script>
    <style>
        @import url("/res/css/all.css");

        @font-face {
            font-family: StarRail;
            src: url("/res/font/zh-cn.woff2");
        }

        * {
            cursor: url("/res/image/webview_cursor_default.png"), auto;
            font-family: StarRail, serif;
        }

        body {
            background: url("/res/image/bg.webp") no-repeat;
            background-size: cover;
        }
    </style>
</head>

<body class="select-none h-screen flex items-center overflow-hidden justify-end mr-[10%]">
    <div id="app" class="box w-full max-w-md border-0">
        <el-form :model="form" :rules="rules" ref="registerForm" @submit.prevent="submitForm">
            <div class="rounded px-8 pt-6 pb-8 mb-4 bg-white">

                <div class="mb-4 text-center">
                    <h1 class="text-2xl text-gray-800 underline decoration-blue-600">用户注册</h1>
                </div>

                <!-- 用户名输入 -->
                <div class="mb-3">
                    <label class="block text-gray-700 text-sm mb-2">用户名</label>
                    <el-input v-model="form.username" type="text" class="h-10" placeholder="请输入用户名">
                        <template #prefix>
                            <el-icon class="el-input__icon">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32">
                                    <path
                                        d="M16 5C12.144531 5 9 8.144531 9 12C9 14.410156 10.230469 16.550781 12.09375 17.8125C8.527344 19.34375 6 22.882813 6 27L8 27C8 24.109375 9.527344 21.59375 11.8125 20.1875C12.484375 21.835938 14.121094 23 16 23C17.878906 23 19.515625 21.835938 20.1875 20.1875C22.472656 21.59375 24 24.109375 24 27L26 27C26 22.882813 23.472656 19.34375 19.90625 17.8125C21.769531 16.550781 23 14.410156 23 12C23 8.144531 19.855469 5 16 5 Z M 16 7C18.773438 7 21 9.226563 21 12C21 14.773438 18.773438 17 16 17C13.226563 17 11 14.773438 11 12C11 9.226563 13.226563 7 16 7 Z M 16 19C16.820313 19 17.601563 19.117188 18.34375 19.34375C17.996094 20.308594 17.089844 21 16 21C14.910156 21 14.003906 20.308594 13.65625 19.34375C14.398438 19.117188 15.179688 19 16 19Z" />
                                </svg>
                            </el-icon>
                        </template>
                    </el-input>
                </div>

                <!-- 密码输入 -->
                <div class="mb-3">
                    <label class="block text-gray-700 text-sm mb-2">密码</label>
                    <el-input v-model="form.password" type="password" class="h-10" placeholder="请输入密码">
                        <template #prefix>
                            <el-icon class="el-input__icon">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32">
                                    <path
                                        d="M16 3C12.144531 3 9 6.144531 9 10L9 13L6 13L6 29L26 29L26 13L23 13L23 10C23 6.144531 19.855469 3 16 3 Z M 16 5C18.773438 5 21 7.226563 21 10L21 13L11 13L11 10C11 7.226563 13.226563 5 16 5 Z M 8 15L24 15L24 27L8 27 Z M 12 20C11.449219 20 11 20.449219 11 21C11 21.550781 11.449219 22 12 22C12.550781 22 13 21.550781 13 21C13 20.449219 12.550781 20 12 20 Z M 16 20C15.449219 20 15 20.449219 15 21C15 21.550781 15.449219 22 16 22C16.550781 22 17 21.550781 17 21C17 20.449219 16.550781 20 16 20 Z M 20 20C19.449219 20 19 20.449219 19 21C19 21.550781 19.449219 22 20 22C20.550781 22 21 21.550781 21 21C21 20.449219 20.550781 20 20 20Z" />
                                </svg>
                            </el-icon>
                        </template>
                    </el-input>
                </div>

                <!-- 验证码输入 -->
                <div class="mb-3">
                    <label class="block text-gray-700 text-sm mb-2">验证码</label>
                    <div class="flex items-center gap-2 w-full!">
                        <div class="flex items-center gap-2 w-full!">
                            <el-input v-model="form.captcha" type="captcha" class="h-10 w-full!" placeholder="请输入验证码">
                                <template #prefix>
                                    <el-icon class="el-input__icon">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32">
                                            <path
                                                d="M3 6L3 26L29 26L29 6 Z M 5 8L27 8L27 24L5 24 Z M 14.5 12C13.128906 12 12 13.128906 12 14.5L12 16.5C12 17.871094 13.128906 19 14.5 19C15.871094 19 17 17.871094 17 16.5L15 16.5C15 16.78125 14.78125 17 14.5 17C14.21875 17 14 16.78125 14 16.5L14 14.5C14 14.21875 14.21875 14 14.5 14C14.78125 14 15 14.21875 15 14.5L17 14.5C17 13.128906 15.871094 12 14.5 12 Z M 21.5 12C20.132813 12 19 13.132813 19 14.5C19 14.816406 19.046875 15.125 19.15625 15.40625C18.460938 15.851563 18 16.621094 18 17.5C18 18.867188 19.132813 20 20.5 20C21.867188 20 23 18.867188 23 17.5C23 17.183594 22.953125 16.875 22.84375 16.59375C23.539063 16.148438 24 15.378906 24 14.5C24 13.132813 22.867188 12 21.5 12 Z M 8.90625 12.59375L7.09375 13.40625L7.9375 15.40625L9.78125 14.59375 Z M 21.5 14C21.789063 14 22 14.210938 22 14.5C22 14.789063 21.789063 15 21.5 15C21.210938 15 21 14.789063 21 14.5C21 14.210938 21.210938 14 21.5 14 Z M 10.21875 15.59375L8.375 16.40625L10.09375 20.40625L11.90625 19.59375 Z M 20.5 17C20.789063 17 21 17.210938 21 17.5C21 17.789063 20.789063 18 20.5 18C20.210938 18 20 17.789063 20 17.5C20 17.210938 20.210938 17 20.5 17Z" />
                                        </svg>
                                    </el-icon>
                                </template>
                            </el-input>
                        </div>
                        <img id="captcha-image" src="/admin/get_captcha" alt="验证码"
                            class="w-20 h-10 border border-gray-300 rounded object-cover cursor-pointer"
                            @click="refreshCaptcha">
                    </div>
                </div>

                <!-- 登录按钮 -->
                <el-button type="primary" @click="submitForm()" class="mb-3 w-full h-11!">
                    注册
                </el-button>

                <p class="block text-sm text-red-600 underline decoration-red-600">*重置密码请前往配置文件修改</p>
            </div>
        </el-form>
        <!-- 鼠标点击音效 -->
        <audio id="click-sound" src="/res/audio/dlc_common_reward.mp3" preload="auto"></audio>
    </div>

    <!-- 水印信息 -->
    <div class="watermark select-none">
        真白管理面板 V1.0 Alpha
        <br>
        ©2025 遂沫 - 开发&维护
    </div>
</body>

<script>
    const app = Vue.createApp({
        data() {
            return {
                form: {
                    username: '',
                    password: '',
                    captcha: ''
                },
                captchaUrl: '/users/user_get_captcha?' + Date.now(),
                loading: false,
                rules: {
                    username: [
                        { required: true, message: '用户名不能为空', trigger: 'blur' },
                        { min: 8, message: '用户名长度至少为8位', trigger: 'blur' }
                    ],
                    password: [
                        { required: true, message: '密码不能为空', trigger: 'blur' },
                        { min: 8, message: '密码长度至少为8位', trigger: 'blur' }
                    ],
                    captcha: [
                        { required: true, message: '验证码不能为空', trigger: 'blur' }
                    ]
                }
            }
        },
        methods: {
            // 刷新验证码
            refreshCaptcha() {
                const timestamp = new Date().getTime();
                $('#captcha-image').attr('src', `/users/user_get_captcha?t=${timestamp}`);
                this.captcha = '';
                this.errorMessage = '';
            },

            // 提交表单
            async submitForm() {
                this.$refs.registerForm.validate(async valid => {
                    if (valid) {
                        try {
                            this.loading = true
                            const json = JSON.stringify({
                                username: this.form.username,
                                password: this.form.password,
                                captcha: this.form.captcha,
                            });
                            const response = await axios.post('/users/user_register', json)

                            if (response.data.success) {
                                ElementPlus.ElMessage.success('注册成功，即将跳转到登录页')
                                setTimeout(() => {
                                    window.location.href = './login.html'
                                }, 1500)
                            } else {
                                ElementPlus.ElMessage.error(response.data.message)
                                this.refreshCaptcha()
                            }
                        } catch (error) {
                            ElementPlus.ElMessage.error('请求失败：' + error.message)
                            this.refreshCaptcha()
                        } finally {
                            this.loading = false
                        }
                    } else {
                        ElementPlus.ElMessage.warning('请正确填写表单')
                        return false
                    }
                })
            }
        }
    })

    app.use(ElementPlus)
    app.mount('#app')
</script>

</html>