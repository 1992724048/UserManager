<!DOCTYPE html>
$cookie$
<html lang="zh-cn">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文件管理</title>
    <script src="/res/js/tailwind.js"></script>
    <script src="/res/js/jquery-3.7.1.min.js"></script>
    <script src="/res/js/vue.global.js"></script>
    <script src="/res/js/all.js"></script>
    <script src="/res/js/element-plus.js"></script>
    <link rel="stylesheet" href="/res/css/element-plus.css">
    <style>
        @font-face {
            font-family: StarRail;
            src: url("/res/font/zh-cn.ttf");
        }

        * {
            cursor: url("/res/image/webview_cursor_default.png"), auto;
            font-family: StarRail, serif;
        }

        ::-webkit-scrollbar {
            width: 3px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #3F9EFF;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgb(22, 79, 250);
        }
    </style>
</head>

<body>
    <div id="app" class="p-2 mt-15!">
        <div class="mb-2 flex items-center gap-2">

            <div class="bg-white p-3 rounded mr-1">
                <el-button type="primary" @click="refresh">
                    <el-icon style="vertical-align: middle">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32">
                            <path
                                d="M16 4C9.382813 4 4 9.382813 4 16L6 16C6 10.484375 10.484375 6 16 6C19.695313 6 22.925781 8.011719 24.65625 11L21 11L21 13L28 13L28 6L26 6L26 9.40625C23.855469 6.152344 20.179688 4 16 4 Z M 26 16C26 21.515625 21.515625 26 16 26C12.304688 26 9.074219 23.988281 7.34375 21L11 21L11 19L4 19L4 26L6 26L6 22.59375C8.144531 25.847656 11.820313 28 16 28C22.617188 28 28 22.617188 28 16Z" />
                        </svg>
                    </el-icon>
                    <span style="vertical-align: middle">刷新</span>
                </el-button>

                <el-button type="success" @click="backup">
                    <el-icon class="">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32">
                            <path
                                d="M5 5L5 27L27 27L27 5 Z M 7 7L13 7L13 25L7 25 Z M 15 7L19 7L19 25L15 25 Z M 21 7L25 7L25 25L21 25 Z M 10 9C9.449219 9 9 9.449219 9 10C9 10.550781 9.449219 11 10 11C10.550781 11 11 10.550781 11 10C11 9.449219 10.550781 9 10 9 Z M 17 9C16.449219 9 16 9.449219 16 10C16 10.550781 16.449219 11 17 11C17.550781 11 18 10.550781 18 10C18 9.449219 17.550781 9 17 9 Z M 23 9C22.449219 9 22 9.449219 22 10C22 10.550781 22.449219 11 23 11C23.550781 11 24 10.550781 24 10C24 9.449219 23.550781 9 23 9 Z M 10 12C9.449219 12 9 12.449219 9 13C9 13.550781 9.449219 14 10 14C10.550781 14 11 13.550781 11 13C11 12.449219 10.550781 12 10 12 Z M 16 15L16 23L18 23L18 15 Z M 22 15L22 23L24 23L24 15Z" />
                        </svg>
                    </el-icon>
                    <span style="vertical-align: middle">备份</span>
                </el-button>
            </div>
        </div>

        <div class="h-[calc(100vh-150px)] overflow-y-auto rounded w-full!">
            <el-table :data="fileList" stripe class="w-full! h-full!" style="width: 100%">
                <el-table-column prop="filename" label="文件名">
                    <template #default="{ row }">
                        <div class="flex items-center">
                            <img src="/res/image/file.svg" class="size-[15px]! object-cover mr-1!">
                            <span @click="row.is_directory && enterDirectory(row.filename)"
                                :class="{'cursor-pointer text-blue-500 hover:underline': row.is_directory}">
                                {{ row.filename }}
                            </span>
                        </div>
                    </template>
                </el-table-column>

                <el-table-column prop="size" align="center" label="大小" width="120"
                    :formatter="formatSize"></el-table-column>

                <el-table-column prop="creation_time" align="center" label="创建时间" width="200">
                    <template #default="{ row }">
                        <div style="display: flex; align-items: center;"
                            class="justify-center">
                            <el-icon>
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32">
                                    <path
                                        d="M9 4L9 5L5 5L5 27L27 27L27 5L23 5L23 4L21 4L21 5L11 5L11 4 Z M 7 7L9 7L9 8L11 8L11 7L21 7L21 8L23 8L23 7L25 7L25 9L7 9 Z M 7 11L25 11L25 25L7 25 Z M 13 13L13 15L15 15L15 13 Z M 17 13L17 15L19 15L19 13 Z M 21 13L21 15L23 15L23 13 Z M 9 17L9 19L11 19L11 17 Z M 13 17L13 19L15 19L15 17 Z M 17 17L17 19L19 19L19 17 Z M 21 17L21 19L23 19L23 17 Z M 9 21L9 23L11 23L11 21 Z M 13 21L13 23L15 23L15 21 Z M 17 21L17 23L19 23L19 21Z" />
                                </svg>
                            </el-icon>
                            <span style="vertical-align: middle">{{ formatTimestamp(row.creation_time) }}</span>
                        </div>
                    </template>
                </el-table-column>

                <el-table-column prop="modification_time" align="center" label="修改时间" width="200">
                    <template #default="{ row }">
                        <div style="display: flex; align-items: center;"
                            class="justify-center">
                            <el-icon>
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32">
                                    <path
                                        d="M9 4L9 5L5 5L5 27L27 27L27 5L23 5L23 4L21 4L21 5L11 5L11 4 Z M 7 7L9 7L9 8L11 8L11 7L21 7L21 8L23 8L23 7L25 7L25 9L7 9 Z M 7 11L25 11L25 25L7 25 Z M 13 13L13 15L15 15L15 13 Z M 17 13L17 15L19 15L19 13 Z M 21 13L21 15L23 15L23 13 Z M 9 17L9 19L11 19L11 17 Z M 13 17L13 19L15 19L15 17 Z M 17 17L17 19L19 19L19 17 Z M 21 17L21 19L23 19L23 17 Z M 9 21L9 23L11 23L11 21 Z M 13 21L13 23L15 23L15 21 Z M 17 21L17 23L19 23L19 21Z" />
                                </svg>
                            </el-icon>
                            <span style="vertical-align: middle">{{ formatTimestamp(row.modification_time) }}</span>
                        </div>
                    </template>
                </el-table-column>

                <el-table-column label="操作" align="center" class="flex" width="380">
                    <template #default="{ row }">
                        <div class="flex justify-center">
                            <el-popconfirm width="220" icon-color="#626AEF" title="确定要删除该文件吗?" confirm-button-text="确定"
                                cancel-button-text="取消" @confirm="deleteFile(row.filename)" @cancel="">
                                <template #reference>
                                    <el-button size="small" type="danger" plain>
                                        <el-icon style="vertical-align: middle">
                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32">
                                                <path
                                                    d="M6 3L6 29L17.78125 29C19.25 30.828125 21.480469 32 24 32C28.40625 32 32 28.40625 32 24C32 20.289063 29.4375 17.179688 26 16.28125L26 9.59375L25.71875 9.28125L19.71875 3.28125L19.40625 3 Z M 8 5L18 5L18 11L24 11L24 16C19.59375 16 16 19.59375 16 24C16 25.066406 16.210938 26.070313 16.59375 27L8 27 Z M 20 6.4375L22.5625 9L20 9 Z M 24 18C27.324219 18 30 20.675781 30 24C30 27.324219 27.324219 30 24 30C20.675781 30 18 27.324219 18 24C18 20.675781 20.675781 18 24 18 Z M 21.71875 20.28125L20.28125 21.71875L22.5625 24L20.28125 26.28125L21.71875 27.71875L24 25.4375L26.28125 27.71875L27.71875 26.28125L25.4375 24L27.71875 21.71875L26.28125 20.28125L24 22.5625Z" />
                                            </svg>
                                        </el-icon>
                                        <span style="vertical-align: middle">删除</span>
                                    </el-button>
                                </template>
                            </el-popconfirm>

                            <div v-if="!row.is_directory">
                                <el-button type="info" class="ml-1!" size="small" @click="downloadFile(row.filename)"
                                    plain>
                                    <el-icon style="vertical-align: middle">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32">
                                            <path
                                                d="M15 4L15 20.5625L9.71875 15.28125L8.28125 16.71875L15.28125 23.71875L16 24.40625L16.71875 23.71875L23.71875 16.71875L22.28125 15.28125L17 20.5625L17 4 Z M 7 26L7 28L25 28L25 26Z" />
                                        </svg>
                                    </el-icon>
                                    <span style="vertical-align: middle">下载</span>
                                </el-button>
                            </div>
                        </div>
                    </template>
                </el-table-column>
            </el-table>
        </div>

        <!-- 鼠标点击音效 -->
        <audio id="click-sound" src="/res/audio/dlc_common_reward.mp3" preload="auto"></audio>
    </div>
</body>

<script>
    const app = Vue.createApp({
        data() {
            return {
                currentPath: '',
                fileList: [],
            }
        },
        computed: {
            pathParts() {
                return this.currentPath.split('/').filter(p => p);
            }
        },
        methods: {
            fetchFiles() {
                $.post('/sql_file/enum_path', JSON.stringify({ path: this.currentPath })).done((res) => {
                    if (res.success) {
                        this.fileList = res.data;
                    } else {
                        ElementPlus.ElMessage.error({
                            message: res.message,
                            offset: 80
                        })
                    }
                }).fail(() => {
                    ElementPlus.ElMessage.error({
                        message: '获取文件列表失败',
                        offset: 80
                    })
                })
            },
            formatSize(row, column, size) {
                if (row.is_directory) return '-';
                const units = ['B', 'KB', 'MB', 'GB'];
                let i = 0;
                while (size >= 1024 && i < units.length - 1) {
                    size /= 1024;
                    i++;
                }
                return `${size.toFixed(2)} ${units[i]}`;
            },
            formatTimestamp(timestamp) {
                const date = new Date(timestamp * 1000);
                const pad = n => n.toString().padStart(2, '0'); // 补零函数

                return `${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(date.getDate())} ` +
                    `${pad(date.getHours())}:${pad(date.getMinutes())}:${pad(date.getSeconds())}`;
            },
            deleteFile(name) {
                this.confirmDelete(name, '/sql_file/remove_file', '文件');
            },
            confirmDelete(name, api, type) {
                const path = this.currentPath ?
                    `${this.currentPath}/${name}` : name;
                $.post(api, JSON.stringify({ path: path })).done((res) => {
                    if (res.success) {
                        ElementPlus.ElMessage.success({
                            message: res.message,
                            offset: 80
                        });
                        this.fetchFiles();
                    } else {
                        ElementPlus.ElMessage.error({
                            message: res.message,
                            offset: 80
                        });
                    }
                }).fail(function () {
                    ElementPlus.ElMessage.error({
                        message: '操作失败',
                        offset: 80
                    });
                });
            },
            refresh() {
                this.fetchFiles();
                ElementPlus.ElMessage.success({
                    message: '刷新成功!',
                    offset: 80
                })
            },
            downloadFile(filename) {
                const fullPath = this.currentPath ? `${this.currentPath}/${filename}` : filename;
                try {
                    // 构造下载地址
                    const url = `/sql_file/download?path=${encodeURIComponent(fullPath)}&csrf=${this.csrfToken}`;

                    // 创建中间页
                    const closeScript = `
                        <script>
                            let count = 0;
                            // 监听可见性变化（适用于后台下载）
                            document.addEventListener('visibilitychange', () => {
                                if (document.hidden && count++ === 0) {
                                    setTimeout(window.close, 3000) // 3秒后关闭
                                }
                            });
                            // 定时关闭保底
                            setTimeout(window.close, 10000) // 30秒超时关闭
                        <\/script>
                    `;

                    // 打开新窗口并写入内容
                    const win = window.open('about:blank', '_blank');
                    win.document.write(`
                        <html>
                            <body>
                                <iframe src="${url}" style="display:none"></iframe>
                                ${closeScript}
                            </body>
                        </html>
                    `);

                    // 处理弹窗拦截
                    if (!win || win.closed) {
                        throw new Error('请允许弹出窗口以完成下载');
                    }
                } catch (error) {
                    ElementPlus.ElMessage.error(error.message);
                }
            },
            backup() {
                $.post('/sql_file/backup', JSON.stringify({ path: this.currentPath })).done((res) => {
                    if (res.success) {
                        this.fetchFiles();
                        ElementPlus.ElMessage.success({
                            message: res.message,
                            offset: 80
                        }); 
                    } else {
                        this.fetchFiles();
                        ElementPlus.ElMessage.error({
                            message: res.message,
                            offset: 80
                        });
                    }
                }).fail(() => {
                    this.fetchFiles();
                    ElementPlus.ElMessage.error({
                        message: '备份失败',
                        offset: 80
                    });
                });
            }
        },
        mounted() {
            this.fetchFiles();
        }
    });

    app.use(ElementPlus);
    app.mount('#app');
</script>

</html>