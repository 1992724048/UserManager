<!DOCTYPE html>
<html lang="zh-cn">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>系统监控</title>

    <script src="/res/js/tailwind.js"></script>
    <script src="/res/js/jquery-3.7.1.min.js"></script>
    <script src="/res/js/vue.global.js"></script>
    <script src="/res/js/axios.min.js"></script>
    <script src="/res/js/echarts.min.js"></script>
    <script src="/res/js/element-plus.js"></script>
    <link rel="stylesheet" href="/res/css/element-plus.css">
    <style>
        @font-face {
            font-family: StarRail;
            src: url('/res/font/zh-cn.woff2');
        }

        * {
            cursor: url('/res/image/webview_cursor_default.png'), auto;
            font-family: StarRail, serif;
        }

        ::-webkit-scrollbar {
            width: 3px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #3F9EFF;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgb(22, 79, 250);
        }

        #charts {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }

        .chart-box {
            width: 400px;
            height: 300px;
        }
    </style>
</head>

<body class="bg-gray-100 select-none p-2 pb-0 pt-13 w-full">
    <div id="app" class="p-4">
        <!-- 显示 CPU 核心数据 -->
        <el-card class="mt-4 shadow-none!">
            <h2>CPU 核心数据</h2>
            <div class="flex">
                <div id="cpuChart" class="chart-box"></div>
                <div id="cpuHistoryChart" class="chart-box"></div>
                <div id="coreHistoryChart" class="chart-box w-[800px]!"></div>
            </div>
            <el-collapse v-model="activeNames">
                <el-collapse-item title="CPU 核心数据" name="1">
                  <el-row :gutter="20">
                    <el-col v-for="item in cpuCoreTable" :key="item.core" :span="6">
                      <el-card class="m-1 shadow-none!">
                        <div style="text-align: center;">
                          <h4>{{ item.core }}</h4>
                          <p>利用率: {{ item.usage }}%</p>
                        </div>
                      </el-card>
                    </el-col>
                  </el-row>
                </el-collapse-item>
              </el-collapse>              
        </el-card>
        <!-- 显示内存数据 -->
        <el-card class="mt-4 shadow-none!">
            <h2>内存数据</h2>
            <div class="flex">
                <div id="memoryChart" class="chart-box"></div>
                <div id="memoryHistoryChart" class="chart-box"></div>
            </div>
            <p>总内存: {{ performance.memory.totalMB }} MB</p>
            <p>已使用内存: {{ performance.memory.usedMB }} MB</p>
            <p>可用内存: {{ performance.memory.availableMB }} MB</p>
        </el-card>
        <!-- 显示磁盘数据 -->
        <el-card class="mt-4 shadow-none!">
            <h2>磁盘数据</h2>
            <p>总磁盘空间: {{ performance.disk.totalBytes }} Bytes</p>
            <p>可用磁盘空间: {{ performance.disk.freeBytes }} Bytes</p>
            <p>每秒读取字节数: {{ performance.disk.readBytesPerSec }} Bytes/s</p>
            <p>每秒写入字节数: {{ performance.disk.writeBytesPerSec }} Bytes/s</p>
        </el-card>
        <!-- 显示网络数据 -->
        <el-card class="mt-4 shadow-none!">
            <h2>网络数据</h2>
            <p>每秒接收字节数: {{ performance.network.recvBytesPerSec }} Bytes/s</p>
            <p>每秒发送字节数: {{ performance.network.sendBytesPerSec }} Bytes/s</p>
        </el-card>
    </div>

    <!-- 鼠标点击音效 -->
    <audio id="click-sound" src="/res/audio/dlc_common_reward.mp3" preload="auto"></audio>

    <script>
        const { createApp } = Vue;
        const app = createApp({
            data() {
                return {
                    performance: {
                        cpu: { total: 0, perCore: [] },
                        memory: { totalMB: 0, usedMB: 0, availableMB: 0 },
                        disk: { totalBytes: 0, freeBytes: 0, readBytesPerSec: 0, writeBytesPerSec: 0 },
                        network: { recvBytesPerSec: 0, sendBytesPerSec: 0 }
                    },
                    activeNames: [],
                    cpuCoreTable: [],
                    // CPU 总利用率历史数据及对应时间（30 个数据点）
                    cpuHistory: [],
                    // 内存使用率历史数据（百分比，usedMB/totalMB*100）
                    memoryHistory: [],
                    // 各核心历史数据：数组个数与核心数一致，每个为数组
                    coreHistory: [],
                    // 统一的时间轴，所有历史图共用
                    timeHistory: []
                }
            },
            methods: {
                fetchData() {
                    axios.get('/api/info')
                        .then(response => {
                            if (response.data.success) {
                                this.performance = response.data;
                                // 更新 CPU 核心表格数据
                                this.cpuCoreTable = this.performance.cpu.perCore.map((usage, index) => {
                                    return { core: '核心' + index, usage: usage.toFixed(2) };
                                });
                                // 统一时间点
                                const currentTime = new Date().toLocaleTimeString();
                                this.timeHistory.push(currentTime);
                                if (this.timeHistory.length > 30) {
                                    this.timeHistory.shift();
                                }
                                // 更新 CPU 总利用率历史数据
                                this.cpuHistory.push(this.performance.cpu.total);
                                if (this.cpuHistory.length > 30) {
                                    this.cpuHistory.shift();
                                }
                                // 更新内存历史数据（按百分比计算）
                                let memRate = 0;
                                if (this.performance.memory.totalMB > 0) {
                                    memRate = this.performance.memory.usedMB / this.performance.memory.totalMB * 100;
                                }
                                this.memoryHistory.push(memRate);
                                if (this.memoryHistory.length > 30) {
                                    this.memoryHistory.shift();
                                }
                                // 更新各核心历史数据
                                // 若核心数变化则重置 coreHistory
                                if (this.coreHistory.length !== this.performance.cpu.perCore.length) {
                                    this.coreHistory = [];
                                    for (let i = 0; i < this.performance.cpu.perCore.length; i++) {
                                        this.coreHistory.push([]);
                                    }
                                }
                                this.performance.cpu.perCore.forEach((usage, i) => {
                                    this.coreHistory[i].push(usage);
                                    if (this.coreHistory[i].length > 30) {
                                        this.coreHistory[i].shift();
                                    }
                                });
                                // 更新图表数据
                                this.updateCharts();
                            }
                        })
                        .catch(error => {
                            console.error("数据获取失败", error);
                        });
                },
                updateCharts() {
                    // CPU 利用率图表（饼图示例）
                    let cpuChart = echarts.getInstanceByDom(document.getElementById('cpuChart'));
                    if (!cpuChart) {
                        cpuChart = echarts.init(document.getElementById('cpuChart'));
                    }
                    let optionCpu = {
                        title: { text: 'CPU 利用率', left: 'center' },
                        tooltip: { trigger: 'item' },
                        series: [{
                            type: 'pie',
                            radius: '50%',
                            data: [
                                { value: this.performance.cpu.total, name: '总利用率' },
                                { value: 100 - this.performance.cpu.total, name: '空闲' }
                            ],
                            emphasis: {
                                itemStyle: { shadowBlur: 10, shadowOffsetX: 0, shadowColor: 'rgba(0, 0, 0, 0.5)' }
                            }
                        }]
                    };
                    cpuChart.setOption(optionCpu);

                    // 内存使用率图表（柱状图示例）
                    let memoryChart = echarts.getInstanceByDom(document.getElementById('memoryChart'));
                    if (!memoryChart) {
                        memoryChart = echarts.init(document.getElementById('memoryChart'));
                    }
                    let optionMem = {
                        title: { text: '内存使用率', left: 'center' },
                        tooltip: {},
                        xAxis: { data: ['已使用', '空闲'] },
                        yAxis: {},
                        series: [{
                            name: '内存 (MB)',
                            type: 'bar',
                            data: [this.performance.memory.usedMB, this.performance.memory.availableMB]
                        }]
                    };
                    memoryChart.setOption(optionMem);

                    // CPU 历史总利用率折线图
                    let cpuHistoryChart = echarts.getInstanceByDom(document.getElementById('cpuHistoryChart'));
                    if (!cpuHistoryChart) {
                        cpuHistoryChart = echarts.init(document.getElementById('cpuHistoryChart'));
                    }
                    let optionHistory = {
                        title: { text: '历史 CPU 利用率', left: 'center' },
                        tooltip: { trigger: 'axis' },
                        xAxis: {
                            type: 'category',
                            data: this.timeHistory
                        },
                        yAxis: {
                            type: 'value',
                            min: 0,
                            max: 100,
                            axisLabel: { formatter: '{value}%' }
                        },
                        series: [{
                            name: 'CPU 利用率',
                            type: 'line',
                            smooth: true,
                            data: this.cpuHistory,
                            areaStyle: {}
                        }]
                    };
                    cpuHistoryChart.setOption(optionHistory);

                    // 内存历史使用率折线图
                    let memoryHistoryChart = echarts.getInstanceByDom(document.getElementById('memoryHistoryChart'));
                    if (!memoryHistoryChart) {
                        memoryHistoryChart = echarts.init(document.getElementById('memoryHistoryChart'));
                    }
                    let optionMemoryHistory = {
                        title: { text: '历史内存使用率', left: 'center' },
                        tooltip: { trigger: 'axis' },
                        xAxis: {
                            type: 'category',
                            data: this.timeHistory
                        },
                        yAxis: {
                            type: 'value',
                            min: 0,
                            max: 100,
                            axisLabel: { formatter: '{value}%' }
                        },
                        series: [{
                            name: '内存使用率',
                            type: 'line',
                            smooth: true,
                            data: this.memoryHistory,
                            areaStyle: {}
                        }]
                    };
                    memoryHistoryChart.setOption(optionMemoryHistory);

                    // 历史各核心利用率折线图（多条折线）
                    let coreHistoryChart = echarts.getInstanceByDom(document.getElementById('coreHistoryChart'));
                    if (!coreHistoryChart) {
                        coreHistoryChart = echarts.init(document.getElementById('coreHistoryChart'));
                    }
                    let seriesData = [];
                    for (let i = 0; i < this.coreHistory.length; i++) {
                        seriesData.push({
                            name: '核心' + i,
                            type: 'line',
                            smooth: true,
                            data: this.coreHistory[i]
                        });
                    }
                    let optionCoreHistory = {
                        title: { text: '', left: 'center' },
                        tooltip: { trigger: 'axis' },
                        legend: { data: seriesData.map(item => item.name) },
                        xAxis: {
                            type: 'category',
                            data: this.timeHistory
                        },
                        yAxis: {
                            type: 'value',
                            min: 0,
                            max: 100,
                            axisLabel: { formatter: '{value}%' }
                        },
                        series: seriesData
                    };
                    coreHistoryChart.setOption(optionCoreHistory);
                }
            },
            mounted() {
                // 首次加载
                this.fetchData();
                // 每 2 秒更新一次
                setInterval(this.fetchData, 2000);
            }
        });
        app.use(ElementPlus);
        app.mount('#app');
    </script>
</body>

</html>